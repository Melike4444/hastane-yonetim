import React, { useEffect, useMemo, useState } from "react";
import {
  LayoutGrid,
  CalendarDays,
  Users,
  Stethoscope,
  ClipboardList,
  Building2,
  Search,
  Plus,
  X,
} from "lucide-react";

const nav = [
  { key: "dashboard", label: "Dashboard", icon: LayoutGrid },
  { key: "randevular", label: "Randevular", icon: CalendarDays },
  { key: "hastalar", label: "Hastalar", icon: Users },
  { key: "doktorlar", label: "Doktorlar", icon: Stethoscope },
  { key: "muayeneler", label: "Muayeneler", icon: ClipboardList },
  { key: "bolumler", label: "Bölümler", icon: Building2 },
];

async function apiGet(path) {
  const res = await fetch(path);
  if (!res.ok) throw new Error(`${path} -> ${res.status}`);
  return res.json();
}
function cn(...a) { return a.filter(Boolean).join(" "); }

function Shell({ active, setActive, children }) {
  return (
    <div className="min-h-full bg-zinc-950 text-zinc-100">
      <div className="flex min-h-screen">
        <aside className="w-72 border-r border-zinc-800/80 bg-zinc-950/60 backdrop-blur">
          <div className="p-5">
            <div className="rounded-2xl border border-zinc-800 bg-gradient-to-b from-zinc-900 to-zinc-950 p-4 shadow-lg">
              <div className="text-sm text-zinc-400">Hastane Yönetim</div>
              <div className="text-xl font-semibold tracking-tight">Admin Panel</div>
              <div className="mt-3 text-xs text-zinc-500">React + Tailwind • /api proxy</div>
            </div>

            <nav className="mt-6 space-y-1">
              {nav.map((n) => {
                const Icon = n.icon;
                const is = active === n.key;
                return (
                  <button
                    key={n.key}
                    onClick={() => setActive(n.key)}
                    className={cn(
                      "group flex w-full items-center gap-3 rounded-xl px-3 py-2 text-left text-sm transition",
                      is ? "bg-zinc-900 text-white shadow" : "text-zinc-300 hover:bg-zinc-900/60 hover:text-white"
                    )}
                  >
                    <span className={cn(
                      "grid h-9 w-9 place-items-center rounded-xl border transition",
                      is ? "border-zinc-700 bg-zinc-950" : "border-zinc-800 bg-zinc-950/40 group-hover:border-zinc-700"
                    )}>
                      <Icon size={18} />
                    </span>
                    <span className="font-medium">{n.label}</span>
                  </button>
                );
              })}
            </nav>
          </div>
        </aside>

        <main className="flex-1">
          <header className="sticky top-0 z-10 border-b border-zinc-800/80 bg-zinc-950/60 backdrop-blur">
            <div className="flex items-center justify-between px-6 py-4">
              <div>
                <div className="text-xs uppercase tracking-widest text-zinc-500">Hastane Yönetim</div>
                <div className="text-lg font-semibold">
                  {nav.find((n) => n.key === active)?.label}
                </div>
              </div>
              <div className="text-sm text-zinc-400">
                Backend: <span className="text-zinc-200">localhost:8080</span>
              </div>
            </div>
          </header>

          <div className="px-6 py-6">{children}</div>
        </main>
      </div>
    </div>
  );
}

function StatCard({ title, value, hint, Icon }) {
  return (
    <div className="rounded-2xl border border-zinc-800 bg-gradient-to-b from-zinc-900/80 to-zinc-950 p-5 shadow-lg">
      <div className="flex items-start justify-between">
        <div>
          <div className="text-sm text-zinc-400">{title}</div>
          <div className="mt-2 text-3xl font-semibold tracking-tight">{value ?? "—"}</div>
          {hint && <div className="mt-2 text-xs text-zinc-500">{hint}</div>}
        </div>
        <div className="grid h-11 w-11 place-items-center rounded-2xl border border-zinc-800 bg-zinc-950/60">
          <Icon size={18} />
        </div>
      </div>
    </div>
  );
}

function Dashboard() {
  const [stats, setStats] = useState({
    hastalar: null,
    doktorlar: null,
    randevular: null,
    muayeneler: null,
    bolumler: null,
  });
  const [err, setErr] = useState("");

  useEffect(() => {
    let alive = true;
    (async () => {
      try {
        setErr("");
        const [h, d, r, m, b] = await Promise.all([
          apiGet("/api/hastalar"),
          apiGet("/api/doktorlar"),
          apiGet("/api/randevular"),
          apiGet("/api/muayeneler"),
          apiGet("/api/bolumler"),
        ]);
        if (!alive) return;
        setStats({
          hastalar: h?.length ?? 0,
          doktorlar: d?.length ?? 0,
          randevular: r?.length ?? 0,
          muayeneler: m?.length ?? 0,
          bolumler: b?.length ?? 0,
        });
      } catch (e) {
        if (!alive) return;
        setErr(String(e?.message || e));
      }
    })();
    return () => { alive = false; };
  }, []);

  return (
    <div className="space-y-6">
      {err && (
        <div className="rounded-2xl border border-red-900/50 bg-red-950/30 p-4 text-sm text-red-200">
          API hatası: {err}<br />
          (Backend açık mı? http://localhost:8080)
        </div>
      )}

      <div className="grid gap-4 md:grid-cols-2 xl:grid-cols-5">
        <StatCard title="Hastalar" value={stats.hastalar} hint="Kayıtlı hasta" Icon={Users} />
        <StatCard title="Doktorlar" value={stats.doktorlar} hint="Aktif doktor" Icon={Stethoscope} />
        <StatCard title="Randevular" value={stats.randevular} hint="Toplam randevu" Icon={CalendarDays} />
        <StatCard title="Muayeneler" value={stats.muayeneler} hint="Toplam muayene" Icon={ClipboardList} />
        <StatCard title="Bölümler" value={stats.bolumler} hint="Hastane birimleri" Icon={Building2} />
      </div>

      <div className="rounded-2xl border border-zinc-800 bg-zinc-950/40 p-5">
        <div className="text-sm text-zinc-400">Özet</div>
        <div className="mt-2 text-lg font-medium">
          Yönetim paneli hazır. Şimdi en havalı sayfa: <span className="text-zinc-100">Randevular</span>
        </div>
        <div className="mt-2 text-sm text-zinc-500">
          Arama + tablo + modal form + API create (hastaId/doktorId/tarihSaat).
        </div>
      </div>
    </div>
  );
}

function Modal({ open, title, onClose, children }) {
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50">
      <div className="absolute inset-0 bg-black/70" onClick={onClose} />
      <div className="absolute inset-0 flex items-center justify-center p-4">
        <div className="w-full max-w-2xl rounded-2xl border border-zinc-800 bg-zinc-950 shadow-2xl">
          <div className="flex items-center justify-between border-b border-zinc-800 px-5 py-4">
            <div className="text-base font-semibold">{title}</div>
            <button
              onClick={onClose}
              className="rounded-xl border border-zinc-800 bg-zinc-950/60 p-2 text-zinc-300 hover:bg-zinc-900 hover:text-white"
              aria-label="Kapat"
            >
              <X size={18} />
            </button>
          </div>
          <div className="p-5">{children}</div>
        </div>
      </div>
    </div>
  );
}

function Randevular() {
  const [rows, setRows] = useState([]);
  const [hastalar, setHastalar] = useState([]);
  const [doktorlar, setDoktorlar] = useState([]);
  const [q, setQ] = useState("");
  const [open, setOpen] = useState(false);
  const [saving, setSaving] = useState(false);
  const [err, setErr] = useState("");

  const [tarihSaat, setTarihSaat] = useState("");
  const [hastaId, setHastaId] = useState("");
  const [doktorId, setDoktorId] = useState("");

  async function loadAll() {
    setErr("");
    const [r, h, d] = await Promise.all([
      apiGet("/api/randevular"),
      apiGet("/api/hastalar"),
      apiGet("/api/doktorlar"),
    ]);
    setRows(r || []);
    setHastalar(h || []);
    setDoktorlar(d || []);
  }

  useEffect(() => {
    loadAll().catch((e) => setErr(String(e?.message || e)));
  }, []);

  const filtered = useMemo(() => {
    const needle = q.trim().toLowerCase();
    if (!needle) return rows;
    return rows.filter((x) => {
      const hasta = `${x?.hasta?.ad ?? ""} ${x?.hasta?.soyad ?? ""}`.toLowerCase();
      const doktor = `${x?.doktor?.ad ?? ""} ${x?.doktor?.soyad ?? ""}`.toLowerCase();
      const brans = `${x?.doktor?.brans ?? ""}`.toLowerCase();
      const dt = `${x?.tarihSaat ?? ""}`.toLowerCase();
      return (
        hasta.includes(needle) ||
        doktor.includes(needle) ||
        brans.includes(needle) ||
        dt.includes(needle) ||
        String(x?.id ?? "").includes(needle)
      );
    });
  }, [rows, q]);

  async function createRandevu(e) {
    e.preventDefault();
    setSaving(true);
    setErr("");
    try {
      const payload = {
        tarihSaat,
        hastaId: Number(hastaId),
        doktorId: Number(doktorId),
      };

      const res = await fetch("/api/randevular", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(`POST /api/randevular -> ${res.status} ${text}`);
      }

      setOpen(false);
      setTarihSaat("");
      setHastaId("");
      setDoktorId("");
      await loadAll();
    } catch (e2) {
      setErr(String(e2?.message || e2));
    } finally {
      setSaving(false);
    }
  }

  return (
    <div className="space-y-4">
      {err && (
        <div className="rounded-2xl border border-red-900/50 bg-red-950/30 p-4 text-sm text-red-200">
          {err}
        </div>
      )}

      <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div className="flex w-full max-w-xl items-center gap-2 rounded-2xl border border-zinc-800 bg-zinc-950/40 px-4 py-3">
          <Search size={18} className="text-zinc-500" />
          <input
            value={q}
            onChange={(e) => setQ(e.target.value)}
            placeholder="Randevu ara: hasta, doktor, branş, tarih..."
            className="w-full bg-transparent text-sm outline-none placeholder:text-zinc-600"
          />
        </div>

        <button
          onClick={() => setOpen(true)}
          className="inline-flex items-center justify-center gap-2 rounded-2xl border border-zinc-800 bg-white px-4 py-3 text-sm font-semibold text-zinc-900 shadow hover:bg-zinc-100"
        >
          <Plus size={18} />
          Yeni Randevu
        </button>
      </div>

      <div className="overflow-hidden rounded-2xl border border-zinc-800 bg-zinc-950/40">
        <div className="flex items-center justify-between border-b border-zinc-800 px-5 py-4">
          <div>
            <div className="text-sm font-semibold">Randevular</div>
            <div className="text-xs text-zinc-500">{filtered.length} kayıt (toplam {rows.length})</div>
          </div>
          <div className="text-xs text-zinc-500">Tablo • Arama • Modal</div>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-left text-sm">
            <thead className="bg-zinc-950">
              <tr className="text-xs uppercase tracking-wider text-zinc-500">
                <th className="px-5 py-3">ID</th>
                <th className="px-5 py-3">Tarih-Saat</th>
                <th className="px-5 py-3">Hasta</th>
                <th className="px-5 py-3">Doktor</th>
                <th className="px-5 py-3">Branş</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-zinc-800">
              {filtered.map((x) => (
                <tr key={x.id} className="hover:bg-zinc-900/40">
                  <td className="px-5 py-4 font-medium text-zinc-200">{x.id}</td>
                  <td className="px-5 py-4 text-zinc-200">{new Date(x.tarihSaat).toLocaleString("tr-TR")}</td>
                  <td className="px-5 py-4 text-zinc-200">{x?.hasta?.ad} {x?.hasta?.soyad}</td>
                  <td className="px-5 py-4 text-zinc-200">{x?.doktor?.ad} {x?.doktor?.soyad}</td>
                  <td className="px-5 py-4 text-zinc-400">{x?.doktor?.brans}</td>
                </tr>
              ))}
              {filtered.length === 0 && (
                <tr>
                  <td className="px-5 py-10 text-center text-sm text-zinc-500" colSpan={5}>
                    Sonuç bulunamadı.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>

      <Modal open={open} title="Yeni Randevu Oluştur" onClose={() => setOpen(false)}>
        <form onSubmit={createRandevu} className="space-y-4">
          <div className="grid gap-4 md:grid-cols-2">
            <div>
              <label className="text-xs text-zinc-500">Tarih-Saat (ISO)</label>
              <input
                value={tarihSaat}
                onChange={(e) => setTarihSaat(e.target.value)}
                placeholder="2026-01-10T14:30:00"
                className="mt-2 w-full rounded-2xl border border-zinc-800 bg-zinc-950 px-4 py-3 text-sm outline-none placeholder:text-zinc-600 focus:border-zinc-600"
                required
              />
            </div>

            <div>
              <label className="text-xs text-zinc-500">Hasta</label>
              <select
                value={hastaId}
                onChange={(e) => setHastaId(e.target.value)}
                className="mt-2 w-full rounded-2xl border border-zinc-800 bg-zinc-950 px-4 py-3 text-sm outline-none focus:border-zinc-600"
                required
              >
                <option value="" disabled>Hasta seç</option>
                {hastalar.map((h) => (
                  <option key={h.id} value={h.id}>
                    {h.id} • {h.ad} {h.soyad}
                  </option>
                ))}
              </select>
            </div>

            <div className="md:col-span-2">
              <label className="text-xs text-zinc-500">Doktor</label>
              <select
                value={doktorId}
                onChange={(e) => setDoktorId(e.target.value)}
                className="mt-2 w-full rounded-2xl border border-zinc-800 bg-zinc-950 px-4 py-3 text-sm outline-none focus:border-zinc-600"
                required
              >
                <option value="" disabled>Doktor seç</option>
                {doktorlar.map((d) => (
                  <option key={d.id} value={d.id}>
                    {d.id} • {d.ad} {d.soyad} — {d.brans}
                  </option>
                ))}
              </select>
            </div>
          </div>

          <div className="flex items-center justify-end gap-2 pt-2">
            <button
              type="button"
              onClick={() => setOpen(false)}
              className="rounded-2xl border border-zinc-800 bg-zinc-950 px-4 py-3 text-sm text-zinc-200 hover:bg-zinc-900"
            >
              Vazgeç
            </button>
            <button
              disabled={saving}
              type="submit"
              className="rounded-2xl border border-zinc-800 bg-white px-4 py-3 text-sm font-semibold text-zinc-900 hover:bg-zinc-100 disabled:opacity-60"
            >
              {saving ? "Kaydediliyor..." : "Kaydet"}
            </button>
          </div>

          <div className="text-xs text-zinc-500">
            Not: Create için <span className="text-zinc-200">tarihSaat, hastaId, doktorId</span> zorunlu.
          </div>
        </form>
      </Modal>
    </div>
  );
}

export default function App() {
  const [active, setActive] = useState("dashboard");
  return (
    <Shell active={active} setActive={setActive}>
      {active === "dashboard" && <Dashboard />}
      {active === "randevular" && <Randevular />}
      {active !== "dashboard" && active !== "randevular" && (
        <div className="rounded-2xl border border-zinc-800 bg-zinc-950/40 p-6">
          <div className="text-sm text-zinc-400">Yakında</div>
          <div className="mt-2 text-lg font-semibold">Bu sayfayı da aynı şıklıkla yapacağız.</div>
          <div className="mt-2 text-sm text-zinc-500">(CRUD + tablo + modal + arama + filtre)</div>
        </div>
      )}
    </Shell>
  );
}
